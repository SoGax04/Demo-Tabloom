---

# 要件定義書（ドラフト）

## 1. 文書情報

* 文書名：ブックマーク管理・JSON出力・閲覧Web 要件定義書
* 版数：v0.1（ドラフト）
* 作成日：2026-01-29
* 作成者：—

---

## 2. 背景・目的

### 2.1 背景

ブックマーク情報を一元管理し、外部連携しやすいJSONとして出力できる仕組みが必要。また、出力されたJSONを利用して、保存されたブックマークを素早く新規タブで開けるWebサイトが必要。

### 2.2 目的

* ブックマーク情報を **PostgreSQL** で正規化して管理し、信頼できる原本（Single Source of Truth）とする。
* DBの管理内容を **JSONへ書き起こし（エクスポート）** 可能にする。
* エクスポートされたJSONを取得し、ブックマークを **新規タブで開きやすくする閲覧Webサイト** を提供する。

---

## 3. 対象範囲（スコープ）

### 3.1 対象（In Scope）

1. **ブックマーク閲覧Webサイト**

* 保存済みブックマーク情報（JSON）を取得
* ブックマークURLを新規タブで開く操作を提供
* 取得したJSONの内容を基に検索・絞り込み等の操作（※UI詳細は書かない）

2. **ブックマーク管理＋JSON出力システム**

* ブックマーク情報をDB（PostgreSQL）で管理（CRUD）
* フォルダ/タグ等の管理
* DBからJSONを生成（手動/自動）
* エクスポート結果の提供（API/ファイル/静的配信のいずれか）

3. **実行基盤**

* 仮想環境：**Docker**（docker compose 前提）
* DB：**PostgreSQL**

### 3.2 対象外（Out of Scope）

* UIデザイン/画面設計書/ワイヤーフレーム
* ブラウザ拡張機能の開発
* ブラウザ（Chrome等）への直接インポート機能（必要なら追加要件として後日）
* 外部サービス（Notion等）との同期（必要なら追加要件）

---

## 4. 用語定義

* ブックマーク：URLを主とする保存情報（タイトル/メモ等を含む）
* フォルダ：階層構造を持つ分類単位
* タグ：横断的な分類ラベル（多対多）
* エクスポートJSON：DB内容を所定スキーマで書き出したJSON
* 閲覧Web：エクスポートJSONを読み、操作（新規タブで開く等）を提供するWeb

---

## 5. 全体概要（システム構成）

### 5.1 論理構成（推奨）

* PostgreSQL（永続データ）
* 管理API（ブックマーク登録/更新/削除、検索、エクスポート要求）
* エクスポート機能（API内実装 または バッチ/ワーカー）
* JSON配信（管理APIのエンドポイント、または静的ファイルとして配信）
* 閲覧Web（JSON取得→操作提供）

### 5.2 データフロー概要

1. 管理者が管理システムでブックマークを登録/更新
2. エクスポート機能がDBからJSONを生成
3. 閲覧WebがJSONを取得
4. 利用者がブックマークを選択し、新規タブで開く

---

## 6. 前提・制約

* DB：PostgreSQL（バージョンは運用方針に合わせる。例：15/16）
* 実行：Docker / docker compose
* 利用ブラウザ：モダンブラウザ（Chrome/Edge/Firefox/Safariの最新近傍）
* 新規タブ起動はブラウザのポップアップ制限の影響を受けるため、**ユーザー操作（クリック等）に紐づく形**で実行することを前提とする
* UI詳細は本書に含めない

---

## 7. 利用者と権限

### 7.1 想定ロール

* 閲覧者（Viewer）：閲覧WebでJSONを参照し、ブックマークを開く
* 管理者（Admin）：ブックマークをDBで管理し、エクスポートを実行/設定

### 7.2 認証・認可（要件）

* 管理機能（CRUD/エクスポート設定）は **認証必須**
* 閲覧Webは運用方針により以下いずれか

  * (A) 公開：JSONが公開される（アクセス制限なし）
  * (B) 制限：JSON取得に認証を要する（推奨：社内/個人用途ならこちら）
* 最低限、**管理APIは認証必須**とする

---

# 8. 機能要件

## 8.1 ブックマーク閲覧Webサイト（JSON取得・新規タブ起動）

### 8.1.1 JSON取得

* JSONを取得できること

  * 取得元は「URL（API）」または「静的ファイル」等、環境で切替可能とする
* JSON取得に失敗した場合、失敗理由を利用者が把握できる形で通知できること（※UI文言/配置は不問）
* 取得したJSONのバージョン/生成時刻を参照できること（表示方法は不問）

### 8.1.2 ブックマーク参照・検索（操作要件）

* ブックマークの一覧を参照できること
* フォルダ階層に沿って参照できること（階層の表現方法は不問）
* タグやキーワードで検索/絞り込みができること
* URL/タイトル/メモ/タグ/フォルダ名のいずれを検索対象に含めるかは設定可能とする（初期は全対象推奨）

### 8.1.3 新規タブで開く

* 任意のブックマークを **新しいタブで開ける** こと
* フォルダ単位または選択集合を **まとめて新しいタブで開ける** こと（複数タブ）
* 大量に開く場合、ブラウザ制限を考慮し以下のいずれかを満たすこと

  * 開く件数の上限設定、または
  * 段階的に開く（ユーザー操作に紐づく形で実行）
* 開けなかったURLがある場合、一覧として把握できること（※表示方法は不問）

### 8.1.4 補助操作（任意だが推奨）

* URLのコピー
* JSONの手動再読み込み
* 最終更新日時でのソート（他のソートキーは将来拡張）

---

## 8.2 ブックマーク管理＋JSON書き起こしシステム

### 8.2.1 ブックマーク管理（CRUD）

* ブックマークを登録できること
* ブックマークを更新できること
* ブックマークを削除できること（論理削除を推奨）
* ブックマークに以下属性を保持できること（最低限）

  * URL（必須、一意性は方針で選択：推奨は「URL＋フォルダ」単位で重複許容）
  * タイトル（任意）
  * メモ（任意）
  * フォルダ（任意）
  * タグ（任意、複数）
  * 作成日時/更新日時
* URLの妥当性チェック（スキーム/形式）を行えること

### 8.2.2 フォルダ管理

* フォルダの作成/更新/削除ができること
* フォルダは階層構造（親子）を持てること
* フォルダ削除時の扱いを定義すること（いずれか）

  * 配下を含めて削除（論理削除）
  * 配下を親へ繰り上げ
  * 削除不可（配下が空の場合のみ削除可）

### 8.2.3 タグ管理

* タグの作成/名称変更/削除ができること
* ブックマークにタグを付与/解除できること
* タグは大小文字/全半角揺れの扱いを定義すること（初期は「完全一致」推奨）

### 8.2.4 検索・一覧

* 条件指定（キーワード、フォルダ、タグ、更新日等）で検索できること
* ページング取得できること（件数が多い場合を想定）

### 8.2.5 JSONエクスポート

* DBの内容を所定のJSONスキーマで出力できること
* エクスポートは以下を満たすこと

  * 手動実行（管理者操作、API呼び出し等）
  * 自動実行（定期実行：例 1日1回/任意間隔）
* エクスポート結果に **生成日時・スキーマバージョン** を含めること
* エクスポート先（配信方法）は運用により以下いずれか（併用可）

  * (A) APIで最新JSONを返す
  * (B) JSONファイルを生成して静的配信（Nginx等）
  * (C) ファイルを外部ストレージへ配置（将来拡張）
* エクスポート処理の成功/失敗を記録し、失敗理由を追跡できること

### 8.2.6 監査・履歴（推奨）

* だれがいつ何を変更したか（最小限：更新者、更新時刻、対象ID）を保持できること

---

# 9. 外部インターフェース要件

## 9.1 API（例：管理用）

※実装技術は本要件では固定しない（例：REST/GraphQL など）。最低限の概念要件。

* 認証：トークン方式等で保護（JWT/セッション等は設計で決定）
* 主なエンドポイント（例）

  * ブックマーク：作成/取得/更新/削除、検索
  * フォルダ：作成/取得/更新/削除
  * タグ：作成/取得/更新/削除
  * エクスポート：

    * 最新JSON取得
    * エクスポート実行要求
    * エクスポート履歴取得

## 9.2 エクスポートJSONスキーマ（案）

* 目的：閲覧Webが解釈でき、新規タブ起動に必要な情報が欠けないこと
* 推奨：スキーマバージョンを付与し、将来拡張に備える

例（概念）：

```json
{
  "schema_version": "1.0",
  "generated_at": "2026-01-29T12:34:56Z",
  "folders": [
    { "id": "f1", "name": "Tech", "parent_id": null, "sort_order": 100 }
  ],
  "bookmarks": [
    {
      "id": "b1",
      "url": "https://example.com",
      "title": "Example",
      "note": "memo",
      "folder_id": "f1",
      "tags": ["sample", "ref"],
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-01-10T00:00:00Z"
    }
  ]
}
```

* 必須：`url`, `schema_version`, `generated_at`
* 推奨：IDはUUID等の衝突しにくい形式

---

# 10. データ要件（PostgreSQL）

## 10.1 テーブル案

### 10.1.1 bookmarks

* id（PK, UUID）
* url（text, not null）
* title（text）
* note（text）
* folder_id（UUID, FK folders.id, null可）
* is_deleted（boolean, default false）
* created_at（timestamp, not null）
* updated_at（timestamp, not null）

推奨インデックス：

* (url)
* (folder_id)
* (updated_at)
* 検索要件に応じて全文検索（tsvector）導入可

### 10.1.2 folders

* id（PK, UUID）
* name（text, not null）
* parent_id（UUID, FK folders.id, null可）
* sort_order（int）
* is_deleted（boolean）
* created_at, updated_at

### 10.1.3 tags

* id（PK, UUID）
* name（text, not null, unique推奨）
* created_at, updated_at

### 10.1.4 bookmark_tags（中間）

* bookmark_id（UUID, FK）
* tag_id（UUID, FK）
* PK（bookmark_id, tag_id）

### 10.1.5 export_jobs（推奨）

* id（PK, UUID）
* status（success/failure/running）
* started_at, finished_at
* output_location（APIのみの場合は不要）
* error_message（text）

### 10.1.6 users（管理者認証を行う場合）

* id（PK, UUID）
* email/login_id
* password_hash or external_auth_id
* role（admin等）
* created_at, updated_at

---

# 11. 非機能要件

## 11.1 性能

* 目安：ブックマーク1万件程度で検索/取得が実用的に動作すること
* 最新JSON取得はキャッシュ可能（生成頻度に応じてHTTPキャッシュ/ETag等を検討）

## 11.2 可用性・信頼性

* エクスポート失敗時に前回成功JSONを保持し、閲覧Webの利用不能を避ける（推奨）
* DBバックアップ/リストア手順を用意すること

## 11.3 セキュリティ

* 管理APIは認証必須
* 重要情報（DBパスワード等）は環境変数/Secretsで管理
* 通信はHTTPS前提（本番）
* 入力値検証（URL等）と一般的な脆弱性対策（OWASP Top 10相当）

## 11.4 運用性

* ログ：アプリログ（INFO/WARN/ERROR）、監査ログ（推奨）
* ヘルスチェック：API/DBの疎通確認
* マイグレーション：スキーマ変更を管理（仕組みは実装で決定）

## 11.5 保守性

* スキーマバージョンを用いた後方互換（閲覧WebとJSONの互換維持）
* JSON生成処理は再現可能であること（同一DB状態→同一JSONが望ましい）

---

# 12. Docker要件（構成）

## 12.1 コンテナ構成（例）

* postgres
* api（管理API＋エクスポート）
* web（閲覧Web）
* (任意) worker/scheduler（定期エクスポートを分離する場合）
* (任意) nginx（静的配信/リバプロ）

## 12.2 docker compose要件

* ローカルで `docker compose up` により一式起動できること
* DB永続化：volumeを使用
* 環境変数で設定を切替できること（開発/本番相当）

---

# 13. 受入基準（例）

* 管理者がブックマークを登録→更新→削除できる
* フォルダ階層を作成でき、ブックマークを紐づけできる
* タグ付与/解除ができ、検索条件として使える
* DB内容からJSONを生成でき、生成日時・スキーマバージョンが含まれる
* 閲覧WebがJSONを取得できる
* 閲覧Webから任意のブックマークを新規タブで開ける
* まとめて開く操作で、ブラウザ制限を考慮した挙動（上限/段階）が担保される
* エクスポート失敗時に失敗ログが残り、前回成功JSONが利用可能（採用する場合）

---

## 14. 未決事項（次の検討ポイント）

* 閲覧WebのJSON取得は「公開」か「認証必須」か
* URL重複の扱い（許容/禁止、禁止の場合のキー）
* 削除方式（論理削除/物理削除）と復元要件
* 定期エクスポートの頻度、出力先（API/ファイル）、保持世代
* 検索の強さ（部分一致/全文検索/正規化）

---
